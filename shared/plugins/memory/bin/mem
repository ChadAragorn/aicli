#!/usr/bin/env bash

# Memory Management CLI
# Helper tool for managing AI cli memory system

set -e

MEMORY_DIR="$HOME/.ai"
DAILY_NOTES_DIR="$MEMORY_DIR/memory"
GLOBAL_MEMORY="$MEMORY_DIR/MEMORY.md"
HEARTBEAT_STATE="$MEMORY_DIR/memory/heartbeat-state.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

command="${1:-help}"

case "$command" in
  init)
    echo -e "${BLUE}Initializing memory system...${NC}"

    # Create directory
    mkdir -p "$DAILY_NOTES_DIR"

    # Create MEMORY.md if it doesn't exist
    if [[ ! -f "$GLOBAL_MEMORY" ]]; then
      cat > "$GLOBAL_MEMORY" <<'TEMPLATE'
# AI CLI Memory

## ðŸš¨ Auto-Checkpoint Instructions

**CRITICAL**: When context window utilization reaches 85% (15% remaining):

1. **Check context usage** from system warnings (format: `Token usage: X/Y; Z remaining`)
2. **Calculate**: If `(tokens_used / total_budget) >= 0.85`, trigger checkpoint
3. **Determine project name** from primary working directory (basename of the path)
4. **Create checkpoint** by writing to `~/.ai/memory/YYYY-MM-DD-HHMM.md`:
   ```markdown
   # Session: YYYY-MM-DD-HHMM
   # Project: PROJECT-NAME
   # AI: e.g claude, gemini, codex, etc...

   ## Context Checkpoint (85% utilization)

   ### Summary
   [Brief summary of conversation so far]

   ### Key Accomplishments
   - [What was completed]
   - [Decisions made]
   - [Code written]

   ### Lessons Learned
   - [Important insights]
   - [Mistakes and solutions]

   ### Current State
   - [What's in progress]
   - [Next steps]
   ```
5. **Notify user**: "âš ï¸  Context checkpoint created at 85% (saved to ~/.ai/memory/YYYY-MM-DD-HHMM.md)"
6. **Continue working** - no need to restart session unless context is critically full

This prevents losing work when approaching model context limits (works with any model: Opus/Sonnet/Haiku, any context window size).

**Project-specific search**: Session files include `# Project: NAME` header for targeted retrieval (e.g., `mem search "Project: claude-code"`).

## User Preferences
- [Add your preferences here]

## Development Patterns
- [Common patterns you want Claude to follow]

## Lessons Learned
- [Document mistakes and solutions]

TEMPLATE
      echo -e "${GREEN}âœ“ Created $GLOBAL_MEMORY${NC}"
    else
      echo -e "${YELLOW}âœ“ $GLOBAL_MEMORY already exists${NC}"
    fi

    # Initialize heartbeat state
    if [[ ! -f "$HEARTBEAT_STATE" ]]; then
      cat > "$HEARTBEAT_STATE" <<STATE
{
  "lastCheckpoint": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "lastChecks": {}
}
STATE
      echo -e "${GREEN}âœ“ Created heartbeat state${NC}"
    fi

    echo -e "${GREEN}âœ“ Memory system initialized${NC}"
    echo -e "${BLUE}Edit $GLOBAL_MEMORY to add your long-term memory${NC}"
    ;;

  checkpoint)
    TIMESTAMP=$(date +%Y-%m-%d-%H%M)
    NOW=$(date +%H:%M)
    SESSION_FILE="$DAILY_NOTES_DIR/$TIMESTAMP.md"

    mkdir -p "$DAILY_NOTES_DIR"

    # Create or append to session file
    if [[ ! -f "$SESSION_FILE" ]]; then
      cat > "$SESSION_FILE" <<HEADER
# Session: $TIMESTAMP

HEADER
    fi

    # Append checkpoint
    MESSAGE="${2:-Manual checkpoint}"
    cat >> "$SESSION_FILE" <<CHECKPOINT

## Checkpoint $NOW - $MESSAGE

CHECKPOINT

    # Update heartbeat state
    cat > "$HEARTBEAT_STATE" <<STATE
{
  "lastCheckpoint": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "lastSession": "$TIMESTAMP",
  "lastChecks": {
    "manual": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }
}
STATE

    echo -e "${GREEN}âœ“ Checkpoint created in $SESSION_FILE${NC}"
    ;;

  status)
    echo -e "${BLUE}Memory System Status${NC}"
    echo ""

    # Check MEMORY.md
    if [[ -f "$GLOBAL_MEMORY" ]]; then
      SIZE=$(wc -c < "$GLOBAL_MEMORY" | tr -d ' ')
      LINES=$(wc -l < "$GLOBAL_MEMORY" | tr -d ' ')
      echo -e "${GREEN}âœ“ MEMORY.md${NC}: $LINES lines, $SIZE bytes"
    else
      echo -e "${RED}âœ— MEMORY.md${NC}: Not found (run: mem init)"
    fi

    # Check daily notes
    if [[ -d "$DAILY_NOTES_DIR" ]]; then
      COUNT=$(find "$DAILY_NOTES_DIR" -name "*.md" | wc -l | tr -d ' ')
      echo -e "${GREEN}âœ“ Daily notes${NC}: $COUNT files"

      # Show recent notes
      if [[ $COUNT -gt 0 ]]; then
        echo ""
        echo -e "${BLUE}Recent daily notes:${NC}"
        find "$DAILY_NOTES_DIR" -name "*.md" | sort -r | head -5 | while read file; do
          BASENAME=$(basename "$file")
          SIZE=$(wc -l < "$file" | tr -d ' ')
          echo "  - $BASENAME ($SIZE lines)"
        done
      fi
    else
      echo -e "${YELLOW}âš  Daily notes${NC}: Directory not found"
    fi

    # Check heartbeat state
    echo ""
    if [[ -f "$HEARTBEAT_STATE" ]]; then
      LAST_CHECKPOINT=$(jq -r '.lastCheckpoint' "$HEARTBEAT_STATE" 2>/dev/null || echo "unknown")
      echo -e "${GREEN}âœ“ Last checkpoint${NC}: $LAST_CHECKPOINT"
    else
      echo -e "${YELLOW}âš  Heartbeat state${NC}: Not initialized"
    fi
    ;;

  edit)
    TARGET="${2:-memory}"
    case "$TARGET" in
      memory|MEMORY)
        ${EDITOR:-vim} "$GLOBAL_MEMORY"
        ;;
      last)
        # Edit most recent session file
        LAST_FILE=$(find "$DAILY_NOTES_DIR" -name "*.md" 2>/dev/null | sort -r | head -1)
        if [[ -n "$LAST_FILE" ]]; then
          ${EDITOR:-vim} "$LAST_FILE"
        else
          echo -e "${RED}âœ— No session files found${NC}"
        fi
        ;;
      *)
        # Treat as a file pattern (e.g., "2026-02-16" to edit that day's sessions)
        FILES=$(find "$DAILY_NOTES_DIR" -name "*$TARGET*.md" 2>/dev/null | sort)
        if [[ -n "$FILES" ]]; then
          ${EDITOR:-vim} $FILES
        else
          echo -e "${RED}âœ— No files matching '$TARGET'${NC}"
          echo "Usage: mem edit [memory|last|PATTERN]"
        fi
        ;;
    esac
    ;;

  search)
    QUERY="$2"
    if [[ -z "$QUERY" ]]; then
      echo -e "${RED}Error: Search query required${NC}"
      echo "Usage: mem search <query>"
      exit 1
    fi

    echo -e "${BLUE}Searching memory for: ${NC}\"$QUERY\""
    echo ""

    # Search using rg if available, fallback to grep
    if command -v rg &> /dev/null; then
      rg --color=always -C 2 -n "$QUERY" "$DAILY_NOTES_DIR" 2>/dev/null || \
        echo -e "${YELLOW}No results found${NC}"
    else
      grep -r -C 2 -n "$QUERY" "$DAILY_NOTES_DIR" 2>/dev/null || \
        echo -e "${YELLOW}No results found (install ripgrep for better search)${NC}"
    fi
    ;;

  list)
    LIMIT="${2:-20}"
    echo -e "${BLUE}Recent sessions (last $LIMIT):${NC}"
    echo ""

    if [[ -d "$DAILY_NOTES_DIR" ]]; then
      find "$DAILY_NOTES_DIR" -name "*.md" 2>/dev/null | sort -r | head -n "$LIMIT" | while read file; do
        BASENAME=$(basename "$file" .md)
        LINES=$(wc -l < "$file" | tr -d ' ')
        CHECKPOINTS=$(grep -c "^## Checkpoint" "$file" 2>/dev/null || echo "0")
        echo "  $BASENAME - $LINES lines, $CHECKPOINTS checkpoints"
      done
    else
      echo -e "${YELLOW}No session files found${NC}"
    fi
    ;;

  help|--help|-h)
    cat <<HELP
Memory Management CLI for AI coding cli

Usage: mem <command> [options]

Commands:
  init                Initialize memory system (create directories and files)
  checkpoint [msg]    Create a manual checkpoint in current session
  search <query>      Search through session files using ripgrep
  status              Show memory system status
  edit <target>       Edit memory files
    - memory          Edit MEMORY.md (long-term curated memory)
    - last            Edit most recent session file
    - <pattern>       Edit files matching pattern (e.g., "2026-02-16")
  list [limit]        List recent sessions (default: 20)
  help                Show this help message

Examples:
  mem init                          # Initialize memory system
  mem status                        # Check memory status
  mem search "authentication bug"   # Search session files
  mem checkpoint "Completed feature X"
  mem edit memory                   # Edit MEMORY.md
  mem edit last                     # Edit latest session
  mem edit 2026-02-16               # Edit all sessions from Feb 16
  mem list 10                       # Show last 10 sessions

File Locations:
  Long-term memory:  $GLOBAL_MEMORY
  Session files:     $DAILY_NOTES_DIR/YYYY-MM-DD-HHMM.md
  Heartbeat state:   $HEARTBEAT_STATE

Architecture:
  - MEMORY.md is loaded into every session (curated long-term memory)
  - Session files are created on session end (timestamped raw notes)
  - Use 'mem search' to find context in session files when needed

HELP
    ;;

  *)
    echo -e "${RED}Unknown command: $command${NC}"
    echo "Run 'mem help' for usage information"
    exit 1
    ;;
esac
